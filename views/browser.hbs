{{#> main}}
<style>
    /* Inline overrides if needed, mostly moved to style.css */
    @media (max-width: 640px) {
        .file-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.5rem;
        }
        .file-card {
            padding: 0.8rem;
        }
        .file-thumbnail {
            height: 140px;
        }
    }
</style>

<div class="animate-slide-up browser-wrapper">

    <!-- Sidebar Navigation -->
    <aside class="browser-sidebar glass-panel">
        <div class="sidebar-section-title">Library</div>
        <nav class="sidebar-nav">
             <!-- Mock Links for specific views/filters -->
            <a href="/files/browser" class="sidebar-link active">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                All Files
            </a>
             <a href="#" class="sidebar-link">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Images
            </a>
            <a href="#" class="sidebar-link">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                Videos
            </a>
            <a href="#" class="sidebar-link">
               <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Documents
            </a>
        </nav>

        <div class="sidebar-section-title">Storage</div>
        <nav class="sidebar-nav">
             <a href="#" class="sidebar-link">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
                Local Drive (Main)
            </a>
        </nav>
        
        <div style="margin-top: auto; padding: 1rem;">
            <!-- Space for storage stats or other widgets -->
             <div class="glass-panel" style="padding: 1rem; border: none; background: rgba(255,255,255,0.05);">
                <small style="color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Storage Used</small>
                <div class="usage-bar-container">
                    <div class="usage-bar-fill" style="width: 45%;"></div>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">45% of 1TB</small>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="browser-main">
        <div class="browser-header">
            <h2 style="margin: 0;">File Browser</h2>
            <div style="display: flex; gap: 1rem;">
                <div class="glass-panel sort-controls">
                    <span class="sort-label">Sort by:</span>
                    <select id="sortSelect" onchange="applySort()" class="sort-select">
                        <option value="name">Name</option>
                        <option value="date">Date</option>
                    </select>
                    <button onclick="toggleOrder()" class="btn btn-sm btn-secondary icon-btn" id="orderBtn">
                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                            <path d="M12 5v14M19 12l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary icon-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Upload
                </button>
                <button onclick="createNewFolder()" class="btn btn-secondary icon-btn">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        <line x1="12" y1="11" x2="12" y2="17"></line>
                        <line x1="9" y1="14" x2="15" y2="14"></line>
                    </svg>
                    New Folder
                </button>
            </div>
        </div>

        <div class="glass-panel current-path-bar">
            <span style="color: var(--text-muted);">Current Path:</span>
            <code class="path-code">/{{currentPath}}</code>
            {{#if currentPath}}
            <a href="#" onclick="goToPath('{{parentPath}}'); return false;" class="btn btn-sm btn-secondary icon-btn">
                <svg class="icon icon-sm" viewBox="0 0 24 24">
                    <path d="M12 19V5M5 12l7-7 7 7"></path>
                </svg>
                Up Level
            </a>
            {{/if}}
        </div>

        <!-- Drag & Drop Zone -->
        <div id="dropZone" class="dropZone" style="min-height: 50vh;">

            {{#unless files.length}}
            {{#unless currentPath}}
             <!-- Only show empty state if root and empty, OR if subfolder and empty (implicit) -->
             <!-- Logic might need adjustment if currentPath is set but empty files -->
            {{/unless}}
            <div class="empty-state">
                <div class="empty-icon">
                    <svg class="icon-lg" style="opacity: 0.3;" viewBox="0 0 24 24">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <p>This folder is empty.</p>
                <p style="font-size: 0.9rem;">Drag and drop files here to upload.</p>
            </div>
            {{/unless}}

            <ul class="file-grid">
                {{#if currentPath}}
                {{#if files.length}}
                <li class="glass-panel file-card parent-drop-card" ondragover="onParentDropZoneDragOver(event)"
                    ondragleave="onParentDropZoneDragLeave(event)" ondrop="onParentDropZoneDrop(event)">
                    <div class="file-icon">
                        <svg class="icon-lg" style="color: var(--text-muted);" viewBox="0 0 24 24">
                            <circle cx="6" cy="12" r="1.8"></circle>
                            <circle cx="12" cy="12" r="1.8"></circle>
                            <circle cx="18" cy="12" r="1.8"></circle>
                        </svg>
                    </div>
                     <div class="file-name" style="text-align: center;">Move to parent folder</div>
                </li>
                {{/if}}
                {{/if}}
                {{#each files}}
                <li class="glass-panel file-card" 
                    {{#if this.isDirectory}} 
                        onclick="openFolder('{{this.name}}')"
                        ondragover="onFolderDragOver(event)" 
                        ondragleave="onFolderDragLeave(event)"
                        ondrop="onFolderDrop(event, '{{this.name}}')" 
                        {{#unless ../isAdmin}}style="cursor: pointer;" {{/unless}}
                    {{else}} 
                        onclick="previewFile('{{this.name}}')" 
                        draggable="true"
                        ondragstart="onFileDragStart(event, '{{this.name}}')" 
                    {{/if}}>

                    <div class="file-icon">
                        {{#if this.isDirectory}}
                        <svg class="icon-lg" style="color: var(--color-cta);" viewBox="0 0 24 24">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                        {{else if this.isImage}}
                        <img src="/files/download?path={{#if ../currentPath}}{{../currentPath}}/{{/if}}{{this.name}}"
                            alt="{{this.name}}" class="file-thumbnail" loading="lazy"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <svg class="icon-lg fallback-icon" style="color: var(--text-muted); display: none;"
                            viewBox="0 0 24 24">
                             <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        {{else if this.isVideo}}
                        <video class="file-thumbnail" preload="metadata" muted>
                            <source src="/files/download?path={{#if ../currentPath}}{{../currentPath}}/{{/if}}{{this.name}}#t=0.5">
                        </video>
                        {{else}}
                        <svg class="icon-lg" style="color: var(--text-muted);" viewBox="0 0 24 24">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                            <polyline points="13 2 13 9 20 9"></polyline>
                        </svg>
                        {{/if}}
                    </div>
                    <div class="file-name">{{this.name}}</div>

                    {{#unless this.isDirectory}}
                    <div class="file-meta">{{this.sizeMb}} MB</div>
                    {{/unless}}

                    <div class="file-actions">
                        {{#if this.isDirectory}}
                        <button onclick="event.stopPropagation(); openFolder('{{this.name}}')"
                            class="btn btn-sm file-action-eye" title="Open folder">
                            <svg class="icon icon-lg" viewBox="0 0 24 24">
                                <path d="M3 7h5l2 3h11v9a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z"></path>
                                <polyline points="9 14 12 17 15 14"></polyline>
                            </svg>
                        </button>
                        {{else}}
                        <button onclick="event.stopPropagation(); previewFile('{{this.name}}')"
                            class="btn btn-sm file-action-eye" title="View full">
                            <svg class="icon icon-lg" viewBox="0 0 24 24">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                        {{/if}}

                        <button onclick="event.stopPropagation(); renameItem('{{this.name}}')"
                            class="btn btn-sm file-action-btn" title="Rename">
                            <svg class="icon skip-fill" viewBox="0 0 24 24">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            <span>Rename</span>
                        </button>
                        <button onclick="event.stopPropagation(); moveItem('{{this.name}}')"
                            class="btn btn-sm file-action-btn" title="Move">
                            <svg class="icon skip-fill" viewBox="0 0 24 24">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                            <span>Move</span>
                        </button>
                        <button onclick="event.stopPropagation(); deleteItem('{{this.name}}')"
                            class="btn btn-sm btn-danger file-action-btn" title="Delete">
                            <svg class="icon skip-fill" viewBox="0 0 24 24">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                            <span>Delete</span>
                        </button>

                    </div>
                </li>
                {{/each}}
            </ul>
        </div>
    </main>

    <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFiles(this.files)">

    <!-- Advanced Preview Modal (Lightbox) -->
    <div id="previewModal" class="modal-overlay" onclick="closePreview(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div style="display: flex; flex-direction: column;">
                     <h3 id="modalTitle" style="margin: 0; font-family: 'Fira Code', monospace; color: var(--color-cta);">filename.ext</h3>
                     <small id="modalMeta" style="color: var(--text-muted); font-size: 0.8rem;">0.0 MB</small>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <a id="modalDownloadLink" href="#" class="btn btn-primary icon-btn" download style="padding: 6px 12px; font-size: 0.8rem;">
                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download
                    </a>
                    <button class="btn-close" onclick="closePreview(event)" style="font-size: 2rem;">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="modalBody" style="background: repeating-conic-gradient(#1e293b 0% 25%, transparent 0% 50%) 50% / 20px 20px;">
                <!-- Content injected here -->
            </div>
            <!-- Navigation Controls (Visible only when relevant) -->
             <div id="modalNav" style="display: none; justify-content: space-between; position: absolute; top: 50%; width: 100%; padding: 0 1rem; transform: translateY(-50%); pointer-events: none;">
                 <button onclick="navigatePreview(-1)" class="btn btn-secondary" style="pointer-events: auto; border-radius: 50%; width: 48px; height: 48px; background: rgba(0,0,0,0.5); border: none; color: white;">&lt;</button>
                 <button onclick="navigatePreview(1)" class="btn btn-secondary" style="pointer-events: auto; border-radius: 50%; width: 48px; height: 48px; background: rgba(0,0,0,0.5); border: none; color: white;">&gt;</button>
             </div>
        </div>
    </div>

</div>

<script>
    const currentPath = "{{currentPath}}";
    const parentPath = "{{parentPath}}";
    // Prepare file list for navigation
    const allFiles = [
        {{#each files}}
            { name: "{{this.name}}", isImage: {{this.isImage}}, isVideo: {{this.isVideo}}, isDir: {{this.isDirectory}} },
        {{/each}}
    ];
    let currentPreviewIndex = -1;

    function handleFiles(files) {
        if (!files.length) return;

        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('files', file);
        });
        formData.append('path', currentPath);

        fetch('/files/upload', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.uploaded) {
                        const warnings = data.uploaded.filter(u => u.original !== u.final);
                        if (warnings.length > 0) {
                            const msg = warnings.map(w => `"${w.original}" -> "${w.final}"`).join('\n');
                            alert(`Duplicate files renamed:\n${msg}`);
                        }
                    }
                    window.location.reload();
                } else {
                    alert('Upload failed');
                }
            })
            .catch(err => console.error(err));
    }

    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    function createNewFolder() {
        const name = prompt("Enter folder name:");
        if (!name) return;

        fetch('/files/mkdir', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: currentPath, name })
        }).then(() => window.location.reload());
    }

    function deleteItem(name) {
        if (!confirm(`Delete ${name}?`)) return;

        fetch('/files/delete', {
            method: 'DELETE', // Using DELETE verb but explicit endpoint
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: currentPath ? currentPath + '/' + name : name })
        }).then(() => window.location.reload());
    }

    function renameItem(name) {
        const newName = prompt("Enter new name:", name);
        if (!newName || newName === name) return;

        fetch('/files/rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                path: currentPath ? currentPath + '/' + name : name,
                newName
            })
        }).then(() => window.location.reload());
    }

    function goToPath(path) {
        const url = new URL(window.location.origin + '/files/browser');
        if (path) {
            url.searchParams.set('path', path);
        }
        const currentUrl = new URL(window.location.href);
        const currentSort = currentUrl.searchParams.get('sort');
        const currentOrder = currentUrl.searchParams.get('order');
        if (currentSort) url.searchParams.set('sort', currentSort);
        if (currentOrder) url.searchParams.set('order', currentOrder);
        window.location.href = url.toString();
    }

    function openFolder(name) {
        const base = currentPath ? currentPath + '/' : '';
        goToPath(base + name);
    }

    function applySort() {
        const sortBy = document.getElementById('sortSelect').value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('sort', sortBy);
        window.location.href = currentUrl.toString();
    }

    function toggleOrder() {
        const currentUrl = new URL(window.location.href);
        const currentOrder = currentUrl.searchParams.get('order') || 'asc';
        const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
        currentUrl.searchParams.set('order', newOrder);
        window.location.href = currentUrl.toString();
    }

    // Preview Logic
    function previewFile(filename) {
        currentPreviewIndex = allFiles.findIndex(f => f.name === filename);
        updatePreviewModal(filename);
    }

    function navigatePreview(direction) {
        if (event) event.stopPropagation(); // Stop click from closing modal
        
        let newIndex = currentPreviewIndex + direction;
        // Find next viewable file (image or video)
        while (newIndex >= 0 && newIndex < allFiles.length) {
            if (allFiles[newIndex].isImage || allFiles[newIndex].isVideo) {
                currentPreviewIndex = newIndex;
                updatePreviewModal(allFiles[currentPreviewIndex].name);
                return;
            }
            newIndex += direction;
        }
    }

    function updatePreviewModal(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const path = currentPath ? currentPath + '/' + filename : filename;
        const downloadUrl = `/files/download?path=${encodeURIComponent(path)}`;

        const modal = document.getElementById('previewModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        const modalDownload = document.getElementById('modalDownloadLink');
        const modalNav = document.getElementById('modalNav');

        modalTitle.textContent = filename;
        modalDownload.href = downloadUrl;
        modalBody.innerHTML = ''; // Clear previous

        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
            const img = document.createElement('img');
            img.src = downloadUrl;
            modalBody.appendChild(img);
        } else if (['mp4', 'webm'].includes(ext)) {
            const video = document.createElement('video');
            video.src = downloadUrl;
            video.controls = true;
            modalBody.appendChild(video);
        } else {
            modalBody.innerHTML = '<p>Preview not available for this file type.</p>';
        }

        modal.classList.add('active');
        
        // Check if we have prev/next
        const hasNext = allFiles.slice(currentPreviewIndex + 1).some(f => f.isImage || f.isVideo);
        const hasPrev = allFiles.slice(0, currentPreviewIndex).some(f => f.isImage || f.isVideo);
        
        if (hasNext || hasPrev) {
             modalNav.style.display = 'flex';
        } else {
             modalNav.style.display = 'none';
        }
    }

    function closePreview(e) {
        if (e) e.stopPropagation();
        const modal = document.getElementById('previewModal');
        modal.classList.remove('active');
        // Stop video playback
        const video = modal.querySelector('video');
        if (video) video.pause();
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        const modal = document.getElementById('previewModal');
        if (!modal.classList.contains('active')) return;

        if (e.key === 'ArrowRight') {
            navigatePreview(1);
        } else if (e.key === 'ArrowLeft') {
            navigatePreview(-1);
        } else if (e.key === 'Escape') {
            closePreview();
        }
    });

    function moveItem(name) {
        const destination = prompt("Enter destination path (relative to root, e.g. 'photos' or '..'):", currentPath);
        if (destination === null) return; // Cancelled

        performMove(currentPath ? currentPath + '/' + name : name, destination);
    }

    function onFileDragStart(event, name) {
        const sourcePath = currentPath ? currentPath + '/' + name : name;
        event.dataTransfer.setData('text/plain', sourcePath);
        event.dataTransfer.effectAllowed = 'move';
    }

    function onFolderDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        const target = event.currentTarget;
        target.classList.add('drag-over');
    }

    function onFolderDragLeave(event) {
        const target = event.currentTarget;
        target.classList.remove('drag-over');
    }

    function onFolderDrop(event, folderName) {
        event.preventDefault();
        const target = event.currentTarget;
        target.classList.remove('drag-over');

        const sourcePath = event.dataTransfer.getData('text/plain');
        if (!sourcePath) return; // No internal drag data

        const destination = currentPath ? currentPath + '/' + folderName : folderName;
        performMove(sourcePath, destination);
    }

    function onParentDropZoneDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        const target = event.currentTarget;
        target.classList.add('drag-over');
    }

    function onParentDropZoneDragLeave(event) {
        const target = event.currentTarget;
        target.classList.remove('drag-over');
    }

    function onParentDropZoneDrop(event) {
        event.preventDefault();
        const target = event.currentTarget;
        target.classList.remove('drag-over');

        const sourcePath = event.dataTransfer.getData('text/plain');
        if (!sourcePath) return;

        const destination = parentPath || '';
        performMove(sourcePath, destination);
    }

    function performMove(path, destination) {
        fetch('/files/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path, destination })
        }).then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Move failed');
                }
            })
            .catch(() => alert('Move failed'));
    }
</script>
{{/main}}